# 🧠 FcstLabPro v6 + LLM 交易策略增强方案

> 创建日期: 2026-02-13
> 状态: 待实施

---

## 1. 背景

### 当前流程（纯规则）

```
技术指标 → LightGBM → P(涨)/P(跌) → if/else 规则 → 固定信号 + 仓位
```

**局限**：规则是死的，不考虑宏观背景、市场情绪、新闻事件，输出千篇一律。

---

## 2. 增强方案：LLM 作为"策略分析师"

### 架构

```
                    ┌─────────────────┐
技术指标 → LightGBM │ P(涨) = 70.4%   │──┐
                    │ P(跌) = 1.3%    │  │
                    └─────────────────┘  │
                                         ▼
                    ┌─────────────────┐  ┌──────────────────────┐
最近 14 天 K线摘要  │ 价格/涨跌幅/成交量│─▶│                      │
                    └─────────────────┘  │    GPT-4o-mini        │
                    ┌─────────────────┐  │   "策略分析师"         │──▶ 智能策略建议
当前仓位/历史信号   │ 上次信号、持仓天数│─▶│                      │     (嵌入邮件)
                    └─────────────────┘  └──────────────────────┘
```

---

## 3. 三种集成深度

### 📌 Level 1：信号解读（最简单，推荐先做）

**LLM 做什么**：接收模型输出的概率 + 近期 K 线数据，生成一段自然语言解读。

**输入 Prompt 示例**：

```text
你是一位专业的加密货币量化分析师。
以下是 FcstLabPro 模型今日的预测输出：

- 日期: 2026-02-13
- BTC 价格: $67,876
- 未来14天大涨概率: 70.4%
- 未来14天大跌概率: 1.3%
- 模型信号: 强多头
- 建议仓位: 70%

最近 7 天走势:
日期       | 收盘价    | 涨跌幅  | 成交量(亿U)
02-07     | $65,200  | +1.2%  | 18.3
02-08     | $66,100  | +1.4%  | 21.5
...

请用中文给出：
1. 对模型信号的解读（为什么模型看多/看空）
2. 当前市场结构分析（趋势、支撑位、压力位）
3. 具体操作建议（入场点、止损位、目标位）
4. 风险提示
限 200 字以内。
```

**输出效果（嵌入邮件）**：

> 📝 **AI 策略解读**
>
> 模型连续3天输出强多头信号，近7天 BTC 从 $64,500 反弹至 $67,876（+5.2%），
> 成交量温和放大，RSI 从超卖区回升至 58，形成看涨结构。
> 短期支撑 $66,000，压力 $70,000。建议在 $67,500-68,000 区间分批建仓，
> 止损 $65,500（-3.5%），目标 $72,000。注意：模型 Kappa≈0.05，
> 预测力有限，控制单笔仓位不超过总资金 5%。

---

### 📌 Level 2：动态仓位调整

**LLM 做什么**：不只是解读，还输出结构化 JSON，覆盖规则引擎的部分决策。

```
当前规则引擎:  仓位 = 70% (固定公式)
         ↓
LLM 综合判断:  仓位 = 55% (考虑到近期已连涨5天，追高风险大)
```

**要求 LLM 输出结构化 JSON**：

```json
{
  "position_pct": 55,
  "entry_price": 67500,
  "stop_loss": 65500,
  "take_profit": 72000,
  "confidence": "medium",
  "reasoning": "虽然模型看多，但连续上涨后追高风险增加..."
}
```

**安全机制**：

- LLM 输出的仓位不能偏离规则引擎超过 ±20%
- JSON 解析失败时 fallback 到规则引擎
- 记录 LLM 建议 vs 规则引擎的偏差，事后可回测

---

### 📌 Level 3：多源信息融合（进阶）

**LLM 做什么**：除了模型概率和 K 线，还融合外部信息。

```
数据源:
├── LightGBM 概率          (已有)
├── 近期 K 线走势           (已有)
├── 链上数据摘要            (可选, Glassnode 等)
├── 恐惧贪婪指数            (免费 API)
├── 近期重大新闻标题         (RSS/新闻 API)
└── 宏观日历 (FOMC/CPI等)   (免费 API)
         ↓
    GPT-4o-mini 综合分析
         ↓
    策略建议 + 风险评估
```

---

## 4. 推荐路线

| 阶段 | 内容 | 工作量 | 成本/月 |
|------|------|--------|---------|
| **Phase 1** | Level 1 信号解读，嵌入邮件 | 2小时 | ~$0.03 |
| **Phase 2** | Level 2 动态仓位 + 止损止盈 | 半天 | ~$0.05 |
| **Phase 3** | Level 3 多源融合（恐惧贪婪指数等） | 1-2天 | ~$0.10 + 数据API |

---

## 5. 技术实现要点

1. **模型选择**：`gpt-4o-mini` 足够，便宜且快
2. **API Key 管理**：通过 Cloud Run 环境变量 `OPENAI_API_KEY` 传入
3. **容错**：LLM 调用失败时不影响核心信号流程，邮件照发（只是没有 AI 解读段落）
4. **Prompt 版本管理**：Prompt 模板放在 `configs/prompts/` 目录，方便迭代
5. **回测记录**：每次 LLM 输出存入信号 JSON，未来可对比 LLM 建议 vs 实际走势

---

## 5.5 Prompt 中应包含的模型背景信息（关键）

> 你提出的非常好的点：LLM 必须了解预测模型的完整逻辑和局限性，才能正确"加权"信号可信度，而不是盲目相信或忽视。

### 为什么要告诉 LLM

| 不告诉 | 告诉 |
|--------|------|
| LLM 可能把 70% 概率当作"非常确定" | LLM 知道 Kappa≈0.05，会对 70% 保持谨慎 |
| 不了解特征来源，无法判断信号盲区 | 知道只用了技术面，会主动提醒"缺少基本面信息" |
| 无法解释"为什么模型看多" | 能结合 RSI、MA 等特征逻辑给出合理解释 |
| 对 Bull/Bear 双模型结构不理解 | 能正确解读"两个模型同时看多看空"的含义 |

### 应包含的模型背景信息（嵌入 System Prompt）

```text
## 你正在使用的预测系统：FcstLabPro v6

### 1. 系统架构
- 双模型架构：Bull 模型和 Bear 模型各自独立预测
  - Bull 模型：预测 P(未来14天内出现 ≥5% 大涨)
  - Bear 模型：预测 P(未来14天内出现 ≥5% 大跌)
- 两个模型可以同时看多和看空（高波动场景），也可以同时都不触发（震荡场景）

### 2. 标签定义（reversal 策略）
- 前瞻窗口 T=14 天，阈值 X=5%
- 标签看的是未来 14 天内的**极值**（最高/最低价），不是终点价格
- 这意味着：即使标签为"大涨"，14天后的收盘价未必比现在高
- Bull 标签映射：原始标签 2（底部反转=大涨）→ 1，其余 → 0
- Bear 标签映射：原始标签 0（顶部反转=大跌）→ 1，其余 → 0

### 3. 输入特征（5 个特征集，仅技术面）
- **technical**: SMA/EMA (5/10/20/50/100/200)、均线交叉、RSI (6/14/28)、
  MACD、布林带、ATR、动量 (1~21日收益率)、波动率、随机指标 K/D
- **volume**: 成交量均线、量比、OBV、VWAP、量价相关性
- **flow**: 资金流向代理指标
- **sentiment**: 基于价格行为的情绪代理指标（非新闻/社交媒体数据）
- **market_structure**: 模拟资金费率、CVD、买入压力、量价背离

⚠️ 不包含：链上数据、新闻/社交媒体、宏观经济指标、基本面数据

### 4. 模型类型
- LightGBM 梯度提升树（非深度学习，非 LLM）
- 参数：1000棵树, max_depth=5, learning_rate=0.05, 24叶子
- 自动正负样本权重平衡 (auto_scale_pos_weight)

### 5. 评估方式
- Walk-Forward 滑动验证（初始训练集 1500 天，OOS 窗口 63 天，步长 21 天）
- 非简单 train/test split，更接近实战

### 6. 实际性能（请重点关注）
- **Bull 模型**: Accuracy=53.1%, Precision=50.4%, Recall=41.3%, Kappa=0.050
- **Bear 模型**: Accuracy=56.3%, Precision=33.8%, Recall=45.8%, Kappa=0.060
- **Kappa 均约 0.05，仅略好于随机猜测**
- Precision 较低意味着有较多假阳性（误报）
- 模型对大跌的识别能力（Bear Recall=45.8%）略好于大涨（Bull Recall=41.3%）

### 7. 你应如何使用这些信息
- 模型概率不应被视为精确的概率估计，而是一个**方向性倾向指标**
- 概率 >60% 说明技术面特征较一致地指向某方向，但仍有大量不确定性
- 当模型给出强信号时，结合近期 K 线走势判断是否存在技术面以外的驱动因素
- 当 Bull 和 Bear 同时高概率时，说明市场在技术面上呈现矛盾信号，应特别谨慎
- 永远提醒用户：这个模型的预测力有限（Kappa≈0.05），不应单独作为交易依据
```

### 为什么这样设计 Prompt

1. **双模型架构说明** → LLM 理解为什么会有"同时看涨看跌"的矛盾信号
2. **标签是看极值不是终点** → LLM 理解"70% 大涨概率"不意味着 14 天后一定比现在高
3. **特征仅来自技术面** → LLM 知道存在信息盲区，会主动建议关注基本面
4. **Kappa≈0.05** → LLM 不会过度自信，给出的建议会更保守、更强调风控
5. **Precision/Recall 不对称** → LLM 理解 Bear 模型误报率更高，对空头信号更谨慎

---

## 6. 文件变更计划

### 新增文件

| 文件 | 说明 |
|------|------|
| `src/llm/analyst.py` | LLM 策略分析师核心模块 |
| `src/llm/__init__.py` | 模块初始化 |
| `configs/prompts/signal_analyst_v1.txt` | Prompt 模板 |

### 修改文件

| 文件 | 变更 |
|------|------|
| `scripts/weekly_signal.py` | 信号生成后调用 LLM 分析 |
| `scripts/send_signal_email.py` | 邮件模板增加 AI 解读区块 |
| `scripts/docker_entrypoint.sh` | 传递 OPENAI_API_KEY |
| `requirements.txt` | 添加 `openai` 依赖 |

### Cloud Run 环境变量

```bash
gcloud run jobs update daily-btc-signal-v6 \
  --region=asia-east1 \
  --update-env-vars="OPENAI_API_KEY=sk-xxx"
```

---

## 7. 成本估算

| 项目 | 单次 | 每月(30天) |
|------|------|-----------|
| GPT-4o-mini (Level 1) | ~$0.001 | ~$0.03 |
| GPT-4o-mini (Level 2) | ~$0.002 | ~$0.06 |
| 恐惧贪婪指数 API | 免费 | 免费 |
| Cloud Run Job | ~$0.001 | ~$0.03 |
| **合计** | | **< $0.10/月** |
