# 🚀 FcstLabPro: 最终综合报告

**日期**: 2026-02-13 (更新: 含 v1~v6 全版本迭代分析)
**项目**: 比特币价格预测实验平台 (重构与扩展版)
**代码库**: [FcstLabPro](https://github.com/joebling/FcstLabPro)

---

## 1. 项目概览与成果

### 🎯 目标
对标旧项目的最佳实践，重建并扩展比特币价格预测平台 ("FcstLabPro")。目标是打造一个结构清晰、可追溯、可扩展且便于对比的机器学习实验平台。

### 🏗 架构与基础设施
我们已成功实施了稳健的基础设施：
- **多级实验结构**：将实验组织为 `baseline`（基线）、`feature_study`（特征研究）、`param_tuning`（参数调优）等，实现关注点分离。
- **增强型特征注册表**：中央 `FeatureBuilder` 能够生成跨 7 个不同类别的 **340+ 特征**（技术指标、成交量、市场结构、链上数据、情绪、资金流、滞后/滚动窗口）。
- **高级实验追踪器**：支持递归查找、类别筛选和增强元数据记录（Git commit、耗时、详细指标）的 `Tracker` 类。
- **CLI 管理工具**：用于列出、清理和删除实验的 `manage_experiments.py` 脚本，配备强大的过滤器。
- **可复现性**：通过 `.venv` 进行严格的依赖管理，并利用 Git 集成追踪每个实验的代码库状态。

---

## 2. 特征体系扩展

我们大幅扩展了特征空间，以捕捉更多市场动态：

| 特征集 | 数量 | 描述 |
|:---|---:|:---|
| **Technical (技术指标)** | 35 | 标准指标 (RSI, MACD, BB, SMA crosses 等) |
| **Volume (成交量)** | 15 | OBV, Volume SMA, Volume Volatility, 量价相关性 |
| **Market Structure (市场结构)** | 12 | 距离高/低点的距离, 市场状态检测 (牛/熊) |
| **On-chain (链上数据)** | 20 | SOPR (STH/LTH), MVRV, 交易所流量 (模拟/真实) |
| **Sentiment (情绪)** | 5 | 恐惧贪婪指数 (代理), 社交声量 |
| **Flow (资金流)** | 10 | CVD (累积成交量增量), 买入压力 |
| **Lag & Rolling (滞后与滚动)** | 240+ | 关键指标在多个窗口期下的滚动统计量 (mean, std, min, max) |

**特征总数**：从 **77** (旧版) 增加到 **340+** (FcstLabPro v2)。

---

## 3. 关键实验发现

我们进行了广泛的实验，从基础设施验证到深度的日线优化，再到周线策略的探索。

### 3.1 第一阶段：基础设施与基线对比
我们首先通过对比旧版风格的基线与新扩展特征集，验证了新的 v2 基础设施。

#### 对比实验
1.  **`baseline_T14_X8` (v1)**:
    -   **特征**: 77 (仅技术指标 + 成交量)。
    -   **模型**: LightGBM (500 estimators)。
    -   **策略**: 反转标签 (14天窗口, 8% 阈值)。
2.  **`baseline_v2_quick` (v2)**:
    -   **特征**: 340+ (全部 7 个特征集)。
    -   **模型**: LightGBM (200 estimators - "快速" 运行)。
    -   **策略**: 反转标签 (14天窗口, 8% 阈值)。

#### 性能指标 (v1 vs v2)

| 指标 | Baseline v1 (77 特征) | Baseline v2 (340 特征) | 变化 |
|:---|:---:|:---:|:---:|
| **Accuracy** | **37.45%** | 35.09% | 📉 -2.4% |
| **F1 Macro** | **0.3546** | 0.3193 | 📉 -0.035 |
| **Cohen Kappa** | **0.0466** | -0.0130 | 📉 -0.059 |

**洞察**: 初始的 v2 运行 ("quick") 表现不佳，原因为未筛选的特征引入了噪声以及模型 estimators 数量减少。这促使了第二阶段的优化。

---

### 3.2 第二阶段：日线优化循环 (Daily)

我们迭代优化了日线预测模型，从多分类转向二分类，筛选特征并调优参数。

| 阶段 | 实验名 | Accuracy | Kappa | 改进/备注 |
|:---|:---|:---|:---|:---|
| **初始基线** | `baseline_T14_X8` (3分类) | 0.375 | 0.047 | 旧版基准 |
| **标签优化** | `binary_T14_X8` | 0.527 | 0.042 | **Accuracy +40%** (切换至二分类) |
| **特征筛选** | `top30_binary` | 0.541 | 0.064 | **Kappa +52%** (减少噪声) |
| **参数调优** | `conservative` | **0.551** | **0.090** | **Kappa +41%** (最佳日线模型) |
| **链上数据** | `onchain_enhanced` | 0.546 | 0.081 | 相比纯技术指标无即时提升 |
| **模型对比** | XGBoost/CatBoost/RF | 0.531-0.540 | 0.051-0.069 | LightGBM 仍是 SOTA |
| **集成模型** | Voting/Stacking | 0.541-0.547 | 0.071-0.082 | 复杂度未带来显著回报 |

**关键结论**: 复杂的特征（链上/集成）在日线数据上难以击败经过精细调优且特征筛选后的 LightGBM。

---

### 3.3 第三阶段：周线预测突破 (Weekly) 🌟

将关注点转移到周线（Weekly）周期被证明是一个重大突破，产生了最高的稳定性和信号质量。

| 实验名 | 标签 | 特征数 | Accuracy | Kappa | F1 Macro |
|:---|:---|:---|:---|:---|:---|
| `weekly_T4_X5` | T4, X5% | 全量 | 0.571 | 0.127 | 0.564 |
| `weekly_T4_X8` | T4, X8% | 全量 | 0.548 | 0.083 | 0.537 |
| `weekly_T3_X5` | T3, X5% | 全量 | 0.565 | 0.116 | 0.558 |
| `weekly_T2_X3` | T2, X3% | 全量 | 0.548 | 0.082 | 0.535 |
| `weekly_conservative` | T4, X5% + Opt | 全量 | 0.569 | 0.124 | 0.562 |
| `weekly_enhanced` | T4, X5% + Ext | 全量 + Onchain | 0.554 | 0.096 | 0.545 |
| `weekly_refined_top25` | **T4, X5% + Top25** | **25** | **0.576** | **0.138** | **0.570** |
| `weekly_top15` | T4, X5% + Top15 | 15 | 0.564 | 0.113 | 0.556 |

**突破**: `weekly_refined_top25` 实验取得了项目最高分 (**Accuracy 57.6%, Kappa 0.138**)，验证了周线趋势比日线噪声更清晰、更可预测。

#### 💡 实验名与预测目标解析

为了帮助理解上表，以下是实验命名规则与预测目标的详细定义：

1.  **命名规则**: 通常采用 `weekly_T{n}_X{m}_{suffix}`，但也存在简写情况。
    *   **标准格式**: 如 `weekly_T4_X5`，直接在名字中注明了 **T4** (4周) 和 **X5** (5%)。
    *   **简写格式**: 如 `weekly_refined_top25`。
        *   **注意**: 这个名字中虽然未显式包含 `T4_X5`，但 **实际上它继承了该阶段表现最好的标签配置 (T4, X5%)**。
        *   **变量**: 该实验的变量是特征集（精选了 Top 25），因此名字着重强调了 `refined_top25`，省略了未变动的标签参数。

2.  **预测目标 (也就是模型在预测什么?)**
    *   这些实验均为 **二分类 (Binary Classification)** 任务。
    *   **问题定义**: "在当前时间点，比特币在未来 **n周 (T)** 内的最大潜在涨幅是否会超过 **m% (X)**？"
    *   **Label 1 (正例/机会)**: 是的，未来 T 周内最高价相比当前收盘价涨幅 >= X% (适合做多)。
    *   **Label 0 (负例/观望)**: 否，未来涨幅不足 X% (不值得入场或风险较高)。

> **以此为例: `weekly_refined_top25`**
> *   **输入**: 仅使用过去表现最好的 25 个周线特征。
> *   **预测**: 未来 **4周 (T4)** 内，比特币价格是否不仅会上涨，而且最大涨幅会超过 **5% (X5)**？
> *   **结果**: 模型有 57.6% 的准确率判断正确，且 Kappa 系数 0.138 显示其具有显著优于随机猜测的预测能力。

---

### 3.4 第四阶段：Bull & Bear 双模型周预测 🐂🐻

在三分类和单一二分类的基础上，我们进一步将预测拆分为两个独立的专业模型，各自专注于一个方向性问题：

| 模型 | 目标 | 正例含义 | 标签映射 |
|:---|:---|:---|:---|
| 🐂 **Bull 模型** | 判断"会不会大涨？" | 1 = 未来涨幅 ≥ 5% | `{0→0, 1→0, 2→1}` |
| 🐻 **Bear 模型** | 判断"会不会大跌？" | 1 = 未来跌幅 ≥ 5% | `{0→1, 1→0, 2→0}` |

> 两个模型使用**相同的数据/特征/参数**，仅标签映射不同，实现职责分离。

#### v1 初始结果 (T=28, reversal, 无 SPW)

| 指标 | 🐂 Bull | 🐻 Bear | 说明 |
|:---|:---:|:---:|:---|
| **Accuracy** | 58.59% | 59.01% | 两模型准确率相近 |
| **F1 (正例)** | **0.6740** | 0.3379 | Bull 远优于 Bear |
| **Precision (正例)** | **0.6981** | 0.3124 | Bull 精确率 ~70% |
| **Recall (正例)** | 0.6514 | 0.3679 | Bull 能捕捉 65% 的实际大涨 |
| **F1 Macro** | 0.5533 | 0.5206 | 总体平衡性 Bull 更好 |
| **Cohen Kappa** | 0.1084 | 0.0440 | 均属于"几乎无一致性"区间 |

> ⚠️ **重要警告**: v1 Bull 的 F1=0.674 **存在严重的标签不平衡问题**。T=28/X=5% 下 Bull 正例占 66.3%，即使模型总是预测"会涨"也能获得 ~66% 的 Accuracy。Kappa=0.108 证实模型的真实判别力非常有限。详见 3.5 节的版本迭代分析。

#### 信号矩阵分析 (基于 v1 数据，需结合 3.5 节修正)

两模型组合后产生 4 种信号状态，形成完整的市场判断框架：

| Bull 预测 | Bear 预测 | 信号 | 样本数 | 占比 | 含义 |
|:-:|:-:|:---|---:|---:|:---|
| 1 (大涨) | 0 (不跌) | 📈 **强多头** | 2012 | 57.0% | 确认上涨，适合做多 |
| 0 (不涨) | 1 (大跌) | 📉 **强空头** | 1030 | 29.2% | 确认下跌，适合防守/做空 |
| 0 (不涨) | 0 (不跌) | ⏸️ **震荡** | 335 | 9.5% | 无明确方向，观望为主 |
| 1 (大涨) | 1 (大跌) | ⚠️ **高波动** | 151 | 4.3% | 方向不确定但波动大 |

#### 信号有效性验证

| 信号 | 实际大涨比例 | 实际大跌比例 | 解读 |
|:---|:---:|:---:|:---|
| 📈 强多头 | **69.23%** | 26.59% | ✅ 涨的概率最高，跌的概率最低 |
| 📉 强空头 | 58.35% | **33.59%** | ⚠️ 跌的概率最高，但仍有较多涨的噪声 |
| ⏸️ 震荡 | 61.79% | 29.55% | 中性，与总体分布接近 |
| ⚠️ 高波动 | **77.48%** | 15.23% | 🔥 实际以涨为主，模型对"高波动"的识别有偏差 |

#### 特征重要性交叉分析 (Top 20)

| 分类 | 特征 |
|:---|:---|
| **共同重要** (15) | `dist_from_low_365d`, `vol_volatility_20`, `dist_from_low_90d`, `dist_from_low_180d`, `sma_cross_50_200`, `trades_sma_20`, `low_50d_dist`, `vix_proxy_change_7`, `obv`, `obv_sma_20`, `sma_200`, `dist_from_low_30d`, `return_1d`, `vix_proxy_60`, `vol_price_corr_20` |
| **Bull 独有** (5) | `dist_from_high_180d`, `fgi_ma_14`, `flow_momentum_5`, `price_vs_sma_200`, `vix_proxy_14` |
| **Bear 独有** (5) | `dist_from_high_30d`, `high_14d_dist`, `obv_sma_10`, `vol_sma_20`, `vol_volatility_10` |

> **洞察**: 两模型共享 75% 的 Top 特征（以距离低点的距离和波动率为核心），但 Bull 更关注长期趋势指标 (180d/200d SMA)，Bear 更关注短期波动 (10d/30d 波动率)。

#### 模型可用性评估 (v1 版本)

- ⚠️ **Bull 模型 F1=0.674 虚高**: 受 T=28 标签不平衡影响（正例 66.3%），Kappa=0.108 说明真实判别力有限。**需参考 v6 的修正结果**
- ⚠️ **Bear 模型质量一般** (F1=0.338, Precision=0.312)：假信号过多，**仅作辅助参考**，需进一步优化

#### 交易策略框架

```
每周预测流程:
1. 获取最新日线数据 → 计算特征 (约 80~150 个，取决于所选特征集)
2. Bull 模型预测 P(大涨)
3. Bear 模型预测 P(大跌)
4. 综合信号判断:
   - 📈 强多头 (Bull=1, Bear=0): 加仓/做多
   - 📉 强空头 (Bull=0, Bear=1): 减仓/做空
   - ⏸️ 震荡   (Bull=0, Bear=0): 维持当前仓位
   - ⚠️ 高波动 (Bull=1, Bear=1): 降低杠杆/对冲
```

> 📄 详细报告: **`reports/weekly_prediction_report.md`**

---

### 3.5 第五阶段：版本迭代与诊断 🔬 (NEW)

在 v1 双模型的基础上，我们进行了系统的标签/参数/策略迭代（v3→v6），揭示了 v1 指标虚高的根本原因。

#### 标签分布分析（关键发现）

```
reversal 标签:
T= 7, X=5%  → Bull正例=36.6%  Bear正例=28.3%  Normal=35.1%  ← 最三方平衡
T=14, X=5%  → Bull正例=51.8%  Bear正例=33.8%  Normal=14.4%  ← Bull接近50%
T=28, X=5%  → Bull正例=66.3%  Bear正例=30.4%  Normal= 3.3%  ← v1 严重不平衡!

directional 标签:
T= 7, X=5%  → Bull正例=25.7%  Bear正例=21.1%  Normal=53.2%  ← 正例太少!
```

> v1 使用 T=28 导致 Bull 正例高达 66.3%——模型即使**全预测正例**也能得到 ~66% Accuracy。

#### 全版本 Bull 模型对比

| 版本 | 标签策略 | T | SPW | Accuracy | F1 | Precision | Kappa | 评估 |
|:---|:---|:---:|:---:|:---:|:---:|:---:|:---:|:---|
| v1 | reversal | 28 | ❌ | 58.6% | **0.674** | **0.698** | 0.108 | ❌ 虚高 (正例66%) |
| v3 | reversal | 14 | ✅ | 53.0% | 0.455 | 0.503 | 0.049 | ✅ 诚实基线 |
| v4 | reversal | 7 | ✅ | 62.0% | 0.289 | 0.314 | 0.031 | ⚠️ 窗口太短 |
| v5 | directional | 7 | ✅ | 71.4% | 0.209 | 0.251 | 0.040 | ❌ 正例太少 |
| **v6** | **reversal** | **14** | **✅** | 53.1% | 0.454 | **0.504** | 0.051 | **✅ 当前最优** |

#### 全版本 Bear 模型对比

| 版本 | 标签策略 | T | SPW | Accuracy | F1 | Precision | Kappa | 评估 |
|:---|:---|:---:|:---:|:---:|:---:|:---:|:---:|:---|
| v1 | reversal | 28 | ❌ | 59.0% | 0.338 | 0.312 | 0.044 | ⚠️ |
| v3 | reversal | 14 | ✅ | 55.4% | 0.384 | 0.331 | 0.048 | ✅ |
| v4 | reversal | 7 | ✅ | 65.9% | 0.302 | 0.267 | **0.081** | ⚠️ Kappa最高但F1低 |
| v5 | directional | 7 | ✅ | 78.8% | 0.142 | 0.167 | 0.025 | ❌ 崩溃 |
| **v6** | **reversal** | **14** | **✅** | 56.3% | **0.389** | **0.338** | 0.060 | **✅ 当前最优** |

#### 版本演化总结

```
v1 (T=28, 无SPW)       → 高F1但虚高 (标签不平衡)         ❌ 不可信
v3 (T=14, +SPW)        → F1下降但真实，标签更平衡          ✅ 诚实基线
v4 (T=7, +SPW)         → 标签最平衡但信号太弱              ⚠️ 窗口太短
v5 (directional+purge) → F1崩溃，标签策略导致正例太少       ❌ 过度限制
v6 (reversal+T14+5集)  → 复现v3，Bear略有提升             ✅ 当前最优
```

#### 核心结论

> **所有版本 Kappa 均低于 0.11，说明当前特征集对 BTC 短期方向的预测力非常有限。**
> v1 的高 F1 是标签不平衡的假象；修正后 (v3/v6)，Bull 真实 F1 约 0.45，Bear 约 0.39。
> **这是特征信息量不足的瓶颈，而非模型或参数的问题。**

> 📄 详细版本对比: **`reports/weekly_version_comparison.md`**

---

### 3.6 补充分析报告

特定研究领域的详细细分可以在 `reports/` 目录中找到：

-   📄 **`phase2_summary.md`**: 日线优化阶段的综合总结。
-   📄 **`label_study_summary.md`**: 不同标签参数 (T14 vs T7, X5 vs X8) 的分析。
-   📄 **`feature_study_summary.md`**: 特征重要性与筛选 (Top 30 vs Full) 的深度剖析。
-   📄 **`derivatives_analysis.md`**: 利用衍生品数据 (资金费率, CVD) 的具体分析。
-   📄 **`diagnostic_analysis.md`**: 模型诊断检查与错误分析。
-   📄 **`weekly_prediction_report.md`**: Bull & Bear 双模型周预测联合报告（信号矩阵、有效性分析）。
-   📄 **`weekly_version_comparison.md`**: 🆕 v1~v6 全版本对比分析（标签分布、真实指标、演化总结）。
-   📄 **`compare_baseline_...md`**: 初始 v1 vs v2 的详细对比。

---

## 4. 建议与未来工作

基于 v1~v6 全版本迭代的经验教训，我们对项目方向有了更清醒的认识。

### 核心认知更新

> **v1~v6 的迭代证明**: 纯技术面特征对 BTC 短期方向的预测力天然有限 (所有版本 Kappa < 0.11)。
> 继续调参和标签优化已经触及了**信息量瓶颈**。下一步的突破方向应从**扩充信息源**入手。

### 短期 (信息源扩充 — 最高优先级)
1.  **引入真实链上数据**: 接入 Glassnode/CryptoQuant API，获取交易所净流入、SOPR、活跃地址等**真实链上指标**（当前 onchain 特征为模拟数据）。
2.  **引入宏观因子**: 美元指数 (DXY)、10 年期国债收益率、纳指相关性、VIX 等系统性风险因子。
3.  **引入新闻情绪**: 通过 LLM API 或新闻聚合服务获取 BTC 相关新闻的情绪得分。

### 中期 (建模范式转换)
1.  **回归替代分类**: 预测 T 日后的收益率（连续值），而非二分类。连续目标信息量更大、更灵活。
2.  **概率输出 + 阈值调优**: 输出 P(大涨) 和 P(大跌) 的概率值，实现连续仓位管理而非二元决策。
3.  **信号回测**: 将信号矩阵映射到具体仓位策略，运行 PnL 回测以验证实际盈利能力。
4.  **集成方法**: 为 Bull 和 Bear 各自实现 XGBoost + CatBoost 集成，但预期提升有限。

### 长期 (生产化)
1.  **实盘数据管道**: 连接 Binance API + Glassnode API，实现自动化特征计算和每周信号推送。
2.  **深度学习探索**: 利用 `LagRolling` 特征的时序特性，用 LSTM/Transformer 替代 LightGBM。
3.  **多币种扩展**: 将 Bull & Bear 框架扩展到 ETH、SOL 等主流币种。

---

## 5. 交付物

- **代码库**: `src/` 目录下的完整 Python 源码。
- **配置**: `configs/` 目录下所有实验阶段的 YAML 配置文件。
- **报告**: `reports/` 目录下详细的 Markdown 报告。
- **注册表**: `experiments/registry.json` 中所有实验的 JSON 注册表。

**状态**: ✅ 平台已准备好用于高级研究。v1~v6 全版本迭代完成，v6 (reversal+T14+SPW) 为当前最优基线。Bull F1=0.454 (Precision=0.504)，Bear F1=0.389。所有版本 Kappa < 0.11，需扩充信息源以突破预测力瓶颈。
